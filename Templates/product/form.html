{#
vim:filetype=htmldjango:
#}
{% set bundle = Kernel.bundle('ProductBundle') %}
<div class="product-editor">
        {{ CRUD.Action.renderSignatureWidget|raw}}
        {% if CRUD.Record.id %}
            {{ forms.hidden('id', CRUD.Record.id) }}
        {% endif %}

        <div class="row">

            <div class="col-md-6">
                <div class="col-field">
                {{ CRUD.Action.renderField('name')|raw }}
                </div>

                {% if bundle.config('with_sn') %}
                <div class="col-field">
                {{CRUD.Action.renderField('sn')|raw}}
                </div>
                {% endif %}

                <div class="clearfix"> </div>

                {% if bundle.config('with_subtitle') %}
                <div class="col-field">
                {{ CRUD.Action.renderField('subtitle') |raw}}
                </div>
                {% endif %}

                {% if Kernel.bundle('I18N') and bundle.config('with_lang') %}
                <div class="col-field">
                {{CRUD.Action.renderField('lang')|raw}}
                </div>
                {% endif %}

                {% if Kernel.bundle('StatusPlugin') %}
                <div class="col-field">
                {{CRUD.Action.renderField('status')|raw}}
                </div>
                {% endif %}

                <div class="clearfix"> </div>



                {% if bundle.config('with_orig_price') %}
                <div class="col-field">
                {{CRUD.Action.renderField('orig_price')|raw}}
                </div>
                {% endif %}

                {% if bundle.config('with_price') %}
                <div class="col-field">
                {{CRUD.Action.renderField('price')|raw}}
                </div>
                {% endif %}

                <div class="clearfix"> </div>


                <div class="clearfix"> </div>

                {% if bundle.config('with_category') and not bundle.config('with_multicategory') %}
                {{CRUD.Action.renderField('category_id')|raw}}
                {% endif %}

                {% if bundle.config('with_desc') %}
                {{CRUD.Action.renderField('description',{ class: 'mceEditor', rows: 3, cols: 80 })|raw}}
                {% endif %}
            </div>

            {% if bundle.config('with_category') and bundle.config('with_multicategory') %}
            <div class="col-md-3 col-md-offset-2">
                {% for langcode, categories in categoriesByLang %}
                <div class="widget lang lang-{{langcode}} hide">
                    <div class="widget-hd">{% trans langcode %}{% trans 'Category' %}</div>
                    <div class="widget-bd" style="max-height: 400px; overflow: auto; ">
                        {% set subview = CRUD.Action.asView('ActionKit\\View\\StackView',{ "no_form": 1 }) %}
                        {#
                        {{ subview.renderManyToManyEditor(CRUD.Record,'categories', categories) |raw}}
                        #}
                        {{ subview.buildManyToManyRelationalActionViewForExistingRecords(CRUD.Record, 'categories', null, null, categories)|raw}}
                    </div>
                </div>
                {% endfor %}


                {% if bundle.config('with_types') %}
                    <div class="widget">
                        <div class="widget-hd">{% trans '產品類型' %}</div>
                        <div class="widget-bd">
                            <ul>
                            {% for type in CRUD.Record.types %}
                                <li class="product-type" style="padding-bottom: 3px; margin-bottom: 3px; line-height: 200%; border-bottom: 1px solid #d0d0d0;">
                                    <span title="{{type.comment}}">{{type.name}}</span>
                                    {% if type.comment %}
                                    <span class="comment">{{type.comment}}</span>
                                    {% endif %}
                                    <input type="hidden" name="types[{{type.id}}][id]" value="{{type.id}}"/>
                                    <input type="hidden" name="types[{{type.id}}][product_id]" value="{{CRUD.Record.id}}"/>

                                    <div class="pull-right">
                                        <button class="delete-product-type" data-type-id="{{type.id}}">刪除</button>
                                    </div>
                                </li>
                            {% endfor %}
                            </ul>

                            <button id="createProductType{{frag_serial}}">{% trans '新增類型' %}</button>
                        </div>
                    </div>

<script>
$(function() {
    $('.delete-product-type').click(function() {
        var $el = $(this).parents('.product-type');
        var val = $(this).data('typeId');
        if ( val && confirm('確定要刪除這個類型嗎?') ) {
            runAction('ProductBundle::Action::DeleteProductType',{ id: val }, function(resp){
                if (resp.success) {
                    $el.remove();
                }
            });
        }
        return false;
    });

    $('#createProductType{{frag_serial}}').click(function(e) {
        var $btn = $(this);
        var $wrapper = $btn.parent();

        new CRUDDialog('/bs/product_type/crud/dialog',{},{
            onSuccess: function(resp) {
                var $el = $('<div/>').addClass('product-type');
                $el.append( $('<span/>').text(resp.data.name).attr('title',resp.data.comment));

                $el.append( $('<span/>').text('(' + resp.data.comment + ')'));

                $el.append( $('<input/>').attr({ type: 'hidden', name: 'types[' + resp.data.id + '][id]', value: resp.data.id }) );
                $el.append( $('<button/>').text('刪除').click(function() { 
                    $(this).parent().remove();
                }));
                $wrapper.prepend($el);
            }
        });
        return false;
    });
});
</script>
                {% endif %}



            </div>
            {% endif %}
        </div>


        {{CRUD.Action.renderField('content',{ class: 'mceEditor', rows: 7, cols: 80 })|raw}}
        <div class="clear"> </div>

        {% if bundle.config('with_options_content') %}
        {{CRUD.Action.renderField('options_content',{ class: 'mceEditor', rows: 7, cols: 80 })|raw}}
        <div class="clear"> </div>
        {% endif %}

        {% if bundle.config('with_cover_image') %}
            {% include '@ProductBundle/product/cover_image.html' %}
        {% endif %}

        {% if bundle.config('with_spec_image') %}
            {% include '@ProductBundle/product/spec_image.html' %}
        {% endif %}

        {% if bundle.config('with_images') %}
            {% include '@ProductBundle/product/image.html' %}
        {% endif %}

        {% if bundle.config('with_resources') %}
            {% include '@ProductBundle/product/resource.html' %}
        {% endif %}

        {% if bundle.config('with_files') %}
            {% include '@ProductBundle/product/file.html' %}
        {% endif %}

        {% if bundle.config('with_related_products') %}
            {% include '@ProductBundle/product/related.html' %}
        {% endif %}

        <div class="clear"> </div>
        <div class="divider"> </div>

        <div class="collapsible collapse-section" {# data-collapse="persist" #}>
            {% if bundle.config('with_features') %}
                {% include '@ProductBundle/product/feature.html' %}
            {% endif %}

            {% if bundle.config('with_spec') %}
            <h3>產品規格</h3>
            <div>
                {{CRUD.Action.renderField('spec',{ class: 'mceEditor', rows: 4, cols: 80 })|raw}}
            </div>
            {% endif %}

            {% if bundle.config('with_properties') %}
            <h3>規格表</h3>
            <div>
                {% include '@ProductBundle/product/property.html' %}
            </div>
            {% endif %}

            {% if Kernel.bundle('SEOPlugin') 
                and bundle.config('with_seo') 
                and CRUD.Object.getModel().hasColumn('seo_keywords') 
            %}
                {% include '@SEOPlugin/fields_collapsible.html' %}
            {% endif %}


            {# 外部連結 #}
            {% if bundle.config('with_external_link') %}
                <h3>外部連結</h3>
                <div>
                    {{CRUD.Action.renderField('external_link')|raw}}
                </div>
            {% endif %}

            {% if bundle.config('with_cover_option') %}
            <h3>其他選項</h3>
            <div>
                {{CRUD.Action.renderField('is_cover')|raw}}

                {# private products are accessed by token #}
                {% if bundle.config('with_private') %}
                    {% include '@ProductBundle/product/private_token.html' %}
                {% endif %}
            </div>
            {% endif %}

            <h3>詳細資料</h3>
            <div>
                {% include '@CRUD/metadata.html' %}
                <div class="clear"> </div>
            </div>
        </div>
    <div class="clear"> </div>
</div>
<script>
$(function() {
    Product.initEdit();
});
</script>
